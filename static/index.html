<!doctype html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>ISS na żywo</title>
    <script defer src="https://analytics.outpacelab.com/script.js" data-website-id="e3eede0a-cea7-4aea-9229-c0ec45cbc380"></script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
      defer
    ></script>

    <style>
      :root {
        --bg: #0b1020;
        --panel: rgba(10, 14, 28, 0.92);
        --text: #eaf0ff;
        --muted: rgba(234, 240, 255, 0.72);
        --line: rgba(255, 255, 255, 0.12);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }

      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }

      #map {
        height: 100vh;
        width: 100vw;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: baseline;
        justify-content: space-between;
        flex-wrap: wrap;
      }

      .badge {
        font-size: 12px;
        padding: 5px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--line);
      }

      .grid {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 14px;
      }

      .card {
        padding: 10px 12px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .value {
        font-size: 15px;
        font-weight: 900;
      }

      .btn {
        width: 100%;
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        font-weight: 900;
      }

      .status {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }

      .status b {
        color: var(--text);
      }

      .sectionTitle {
        margin-top: 12px;
        font-size: 13px;
        font-weight: 900;
        color: var(--muted);
        letter-spacing: 0.2px;
      }

      .list {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 54vh;
        overflow: auto;
        padding-right: 4px;
      }

      .item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.06);
      }

      .itemBtn {
        appearance: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }

      .itemLeft {
        display: flex;
        flex-direction: column;
        gap: 2px;
        min-width: 0;
      }

      .itemName {
        font-weight: 900;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .itemMeta {
        font-size: 12px;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chev {
        opacity: 0.6;
        font-weight: 900;
      }

      /* Hamburger */
      .fab {
        position: fixed;
        top: calc(12px + env(safe-area-inset-top));
        left: 12px;
        z-index: 9999;
        width: 48px;
        height: 48px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(12, 16, 32, 0.55);
        color: var(--text);
        font-size: 22px;
        font-weight: 900;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      /* Drawer */
      .drawerBg {
        position: fixed;
        inset: 0;
        z-index: 9998;
        display: none;
        align-items: flex-end;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        padding: 12px;
      }

      .drawer {
        width: min(700px, 100%);
        max-height: 82vh;
        overflow: auto;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: var(--panel);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: var(--shadow);
        padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      }

      .drawerTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .drawerTitle {
        font-size: 16px;
        font-weight: 1000;
        letter-spacing: 0.2px;
      }

      .closeBtn {
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        border-radius: 12px;
        padding: 8px 10px;
        font-weight: 900;
      }

      .tabs {
        margin-top: 10px;
        display: flex;
        gap: 8px;
      }

      .tab {
        flex: 1;
        padding: 10px 8px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        font-weight: 1000;
        font-size: 13px;
      }

      .tab.active {
        background: rgba(255, 255, 255, 0.12);
      }

      .tabBody {
        display: none;
        margin-top: 10px;
      }

      .tabBody.active {
        display: block;
      }

      /* Modal astronauty */
      .modalBg {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: none;
        align-items: flex-end;
        justify-content: center;
        padding: 14px;
        z-index: 10000;
      }

      .modal {
        width: min(640px, 100%);
        max-height: 85vh;
        overflow: auto;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(12, 16, 32, 0.96);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
        box-shadow: var(--shadow);
      }

      .modalHeader {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        justify-content: space-between;
      }

      .modalTitle {
        font-size: 16px;
        font-weight: 1000;
      }

      .modalBody {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 12px;
      }

      .avatar {
        width: 96px;
        height: 96px;
        border-radius: 16px;
        object-fit: cover;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.06);
      }

      .bio {
        font-size: 13px;
        line-height: 1.35;
        color: var(--text);
      }

      .bio p {
        margin: 0 0 8px 0;
      }

      .link {
        display: inline-block;
        margin-top: 8px;
        font-size: 13px;
        color: var(--text);
        text-decoration: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.25);
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <button class="fab" id="menuBtn" type="button" aria-label="Menu">☰</button>

    <div class="drawerBg" id="drawerBg" aria-hidden="true">
      <div class="drawer" role="dialog" aria-modal="true">
        <div class="drawerTop">
          <div class="drawerTitle">ISS na żywo</div>
          <button class="closeBtn" id="drawerClose" type="button">Zamknij</button>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="tabStatus" type="button">Status</button>
          <button class="tab" data-tab="tabPeople" type="button">Astronauci</button>
          <button class="tab" data-tab="tabPasses" type="button">Przeloty</button>
        </div>

        <div class="tabBody active" id="tabStatus">
          <div class="row" style="margin-top: 6px">
            <div class="badge" id="updated">Ładowanie…</div>
            <div class="badge" id="statusBadge">—</div>
          </div>

          <div class="grid" style="margin-top: 10px">
            <div class="card">
              <div class="label">Szerokość / długość</div>
              <div class="value" id="coords">–</div>
            </div>

            <div class="card">
              <div class="label">Prędkość (z przesunięcia)</div>
              <div class="value" id="speed">–</div>
            </div>

            <div class="card">
              <div class="label">Liczba osób w kosmosie</div>
              <div class="value" id="people">–</div>
            </div>

            <div class="card">
              <div class="label">Obieg Ziemi (ISS)</div>
              <div class="value" id="orbit">–</div>
            </div>

            <div class="card" style="grid-column: span 2">
              <div class="label">Typowa wysokość lotu</div>
              <div class="value" id="alt">–</div>
            </div>
          </div>

          <button class="btn" id="centerBtn" type="button">Wyśrodkuj na ISS</button>
          <div class="status">Status: <b id="status">–</b></div>
        </div>

        <div class="tabBody" id="tabPeople">
          <div class="sectionTitle">Ludzie w kosmosie (kliknij osobę)</div>
          <div class="list" id="peopleList"></div>
        </div>

        <div class="tabBody" id="tabPasses">
          <div class="sectionTitle">Najbliższe przeloty nad domem</div>
          <div class="list" id="passesList"></div>
        </div>
      </div>
    </div>

    <div class="modalBg" id="modalBg" role="dialog" aria-modal="true">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <div class="modalTitle" id="mTitle">—</div>
            <div class="muted" id="mMeta">—</div>
          </div>
          <button class="closeBtn" id="mClose" type="button">Zamknij</button>
        </div>

        <div class="modalBody">
          <img class="avatar" id="mImg" alt="Zdjęcie osoby" />
          <div class="bio">
            <p id="mText">—</p>
            <a class="link" id="mWiki" href="#" target="_blank" rel="noopener">Otwórz Wikipedię</a>
            <div class="muted" id="mNote"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const UPDATE_MS = 5000;

      const elCoords = document.getElementById("coords");
      const elSpeed = document.getElementById("speed");
      const elPeople = document.getElementById("people");
      const elUpdated = document.getElementById("updated");
      const elOrbit = document.getElementById("orbit");
      const elAlt = document.getElementById("alt");
      const elStatus = document.getElementById("status");
      const statusBadge = document.getElementById("statusBadge");
      const btnCenter = document.getElementById("centerBtn");

      const peopleList = document.getElementById("peopleList");
      const passesList = document.getElementById("passesList");

      const menuBtn = document.getElementById("menuBtn");
      const drawerBg = document.getElementById("drawerBg");
      const drawerClose = document.getElementById("drawerClose");
      const tabs = Array.from(document.querySelectorAll(".tab"));
      const tabBodies = Array.from(document.querySelectorAll(".tabBody"));

      const modalBg = document.getElementById("modalBg");
      const mClose = document.getElementById("mClose");
      const mTitle = document.getElementById("mTitle");
      const mMeta = document.getElementById("mMeta");
      const mImg = document.getElementById("mImg");
      const mText = document.getElementById("mText");
      const mWiki = document.getElementById("mWiki");
      const mNote = document.getElementById("mNote");

      let map, issMarker, issPath;

      function fmt(n, digits = 2) {
        return Number(n).toFixed(digits);
      }

      function fmtTime(tsSeconds) {
        const d = new Date(tsSeconds * 1000);
        return d.toLocaleString("pl-PL", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          day: "2-digit",
          month: "2-digit",
        });
      }

      async function fetchJson(url) {
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} dla ${url}`);
        return res.json();
      }

      function setStatus(txt) {
        elStatus.textContent = txt;
        statusBadge.textContent = txt;
      }

      function openDrawer() {
        drawerBg.style.display = "flex";
        drawerBg.setAttribute("aria-hidden", "false");
      }
      function closeDrawer() {
        drawerBg.style.display = "none";
        drawerBg.setAttribute("aria-hidden", "true");
      }

      menuBtn.addEventListener("click", openDrawer);
      drawerClose.addEventListener("click", closeDrawer);
      drawerBg.addEventListener("click", (e) => {
        if (e.target === drawerBg) closeDrawer();
      });

      tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tabBodies.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(btn.dataset.tab).classList.add("active");
        });
      });

      function openModal() {
        modalBg.style.display = "flex";
      }
      function closeModal() {
        modalBg.style.display = "none";
      }
      mClose.addEventListener("click", closeModal);
      modalBg.addEventListener("click", (e) => {
        if (e.target === modalBg) closeModal();
      });

      function initMap() {
        map = L.map("map", { zoomControl: false, worldCopyJump: true }).setView([20, 0], 2);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 7,
        }).addTo(map);

        L.control.zoom({ position: "topright" }).addTo(map);

        issMarker = L.circleMarker([0, 0], { radius: 8, weight: 2, fillOpacity: 0.7 }).addTo(map);
        issPath = L.polyline([], { weight: 2, opacity: 0.7 }).addTo(map);

        btnCenter.addEventListener("click", () => {
          const ll = issMarker.getLatLng();
          map.setView([ll.lat, ll.lng], Math.max(map.getZoom(), 3), { animate: true });
        });
      }

      function renderPeople(list) {
        peopleList.innerHTML = "";
        if (!list || list.length === 0) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `<div class="itemLeft"><div class="itemName">Brak danych</div><div class="itemMeta">Nie udało się pobrać listy.</div></div>`;
          peopleList.appendChild(div);
          return;
        }

        for (const p of list) {
          const btn = document.createElement("button");
          btn.className = "item itemBtn";
          btn.type = "button";
          btn.innerHTML = `
            <div class="itemLeft">
              <div class="itemName">${p.name ?? "—"}</div>
              <div class="itemMeta">${[p.agency, p.spacecraft].filter(Boolean).join(" • ")}</div>
            </div>
            <div class="chev">›</div>
          `;

          btn.addEventListener("click", async () => {
            try {
              setStatus("Pobieram osobę…");
              const detail = await fetchJson(`/api/person/${p.id}`);

              mTitle.textContent = detail.name ?? "—";
              mMeta.textContent = [detail.agency, detail.position, detail.spacecraft].filter(Boolean).join(" • ") || "—";
              mText.textContent = detail.simple_pl ?? "Brak opisu.";

              const imgUrl = detail.image || (detail.wiki && detail.wiki.thumbnail) || null;
              if (imgUrl) {
                mImg.src = imgUrl;
                mImg.style.display = "block";
              } else {
                mImg.removeAttribute("src");
                mImg.style.display = "none";
              }

              if (detail.wiki && detail.wiki.link) {
                mWiki.href = detail.wiki.link;
                mWiki.style.display = "inline-block";
              } else {
                mWiki.style.display = "none";
              }

              mNote.textContent =
                detail.wiki && detail.wiki.ok
                  ? "Opis pochodzi z polskiej Wikipedii (streszczenie)."
                  : "Nie ma gotowego opisu po polsku. Link prowadzi do Wikipedii (lub wyszukiwania).";

              openModal();
              setStatus("OK");
            } catch (e) {
              console.error(e);
              setStatus("Błąd osoby");
            }
          });

          peopleList.appendChild(btn);
        }
      }

      function renderPasses(passes) {
        passesList.innerHTML = "";
        if (!passes || passes.length === 0) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="itemLeft">
              <div class="itemName">Brak przelotów w najbliższych 48h</div>
              <div class="itemMeta">Jeśli to się powtarza, podkręcimy parametry obliczeń.</div>
            </div>
          `;
          passesList.appendChild(div);
          return;
        }

        for (const p of passes) {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <div class="itemLeft">
              <div class="itemName">Data: ${p.date}, Kierunek: ${p.direction}</div>
              <div class="itemMeta">Godzina: ${p.time_from} do ${p.time_to} • Maks wysokość: ${p.max_elev_deg}°</div>
            </div>
          `;
          passesList.appendChild(div);
        }
      }

      async function updateStatus() {
        const data = await fetchJson("/api/status");

        const lat = data.iss.latitude;
        const lon = data.iss.longitude;

        elCoords.textContent = `${fmt(lat, 3)}, ${fmt(lon, 3)}`;
        elPeople.textContent = `${data.people_in_space}`;
        elOrbit.textContent = `~${data.facts.iss_orbit_minutes} min`;
        elAlt.textContent = `~${data.facts.iss_typical_altitude_km} km (zmienna)`;
        elUpdated.textContent = `Aktualizacja: ${fmtTime(data.iss.timestamp)}`;

        if (data.iss.speed_kmh == null) elSpeed.textContent = "–";
        else elSpeed.textContent = `${fmt(data.iss.speed_kmh, 0)} km/h`;

        issMarker.setLatLng([lat, lon]);

        const pts = issPath.getLatLngs();
        pts.push([lat, lon]);
        if (pts.length > 200) pts.shift();
        issPath.setLatLngs(pts);

        if (pts.length === 1) {
          map.setView([lat, lon], 3);
        }
      }

      async function updatePeople() {
        const data = await fetchJson("/api/people");
        renderPeople(data.people || []);
      }

      async function updatePasses() {
        const data = await fetchJson("/api/passes");
        renderPasses(data.passes || []);
      }

      async function tick() {
        try {
          setStatus("Pobieram…");
          await updateStatus();
          setStatus("OK");
        } catch (e) {
          console.error(e);
          setStatus("Błąd danych");
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        const wait = setInterval(() => {
          if (window.L) {
            clearInterval(wait);
            initMap();

            (async () => {
              try {
                setStatus("Start…");
                await updatePeople();
                await updatePasses();
                await tick();
                setStatus("OK");
              } catch (e) {
                console.error(e);
                setStatus("Błąd startu");
              }
              setInterval(tick, UPDATE_MS);
              setInterval(updatePeople, 60_000);
              setInterval(updatePasses, 15 * 60_000);
            })();
          }
        }, 50);
      });
    </script>
  </body>
</html>
